{% extends 'base_admin.html.twig' %}

{% block title %}Dashboard{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
   

    <!-- KPIs Resume -->
    <div class="row text-center mb-4">
         <h2 class="mb-4">ðŸ“ˆ Statistiques Utilisateurs</h2>
        <div class="col-md-3">
            <div class="card p-3 bg-light">
                <h6>Total Utilisateurs</h6>
                <p id="totalUsers" class="display-6 fw-bold text-primary">...</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light">
                <h6>Actifs</h6>
                <p id="totalActifs" class="display-6 fw-bold text-success">...</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light">
                <h6>Inactifs</h6>
                <p id="totalInactifs" class="display-6 fw-bold text-danger">...</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card p-3 bg-light">
                <h6>Ce Mois</h6>
                <p id="totalMois" class="display-6 fw-bold text-info">...</p>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4">
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <div class="card-body">
                    <div id="chart-role"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <div class="card-body">
                    <div id="chart-status"></div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <div class="card-body">
                    <div id="chart-monthly"></div>
                </div>
            </div>
        </div>
    </div>
</div>
    <!-- KPIs -->
    <div class="row text-center">
        <h2 class="mb-4">ðŸ“ˆ Statistiques Impot</h2>

        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h6>Total Dossiers</h6>
                <p class="display-6 fw-bold text-primary">{{ dossiers|length }}</p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h6>Total ImpÃ´t PayÃ©</h6>
                <p class="display-6 fw-bold text-success">
                    {{ dossiers|map(d => d.totalImpotPaye)|reduce((a, b) => a + b) }}
                </p>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 bg-light">
                <h6>Total ImpÃ´t Ã  Payer</h6>
                <p class="display-6 fw-bold text-danger">
                    {{ dossiers|map(d => d.totalImpot - d.totalImpotPaye)|reduce((a, b) => a + b) }}
                </p>
            </div>
        </div>
    </div>

    <!-- Main Charts -->
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h6>ImpÃ´ts: PayÃ© vs Non PayÃ©</h6>
                <canvas id="impotBar"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h6>ImpÃ´t Total vs PayÃ© dans le Temps</h6>
                <canvas id="lineImpot"></canvas>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm p-3">
                <h6>Courbe des DÃ©clarations (Revenus dans le temps)</h6>
                <canvas id="declarationsLine"></canvas>
            </div>
        </div>
    </div>

    <!-- Extra Charts -->
    <div class="row align-items-stretch">
    <!-- Moyens de Paiement -->
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm p-3 h-100">
            <h6>Moyens de Paiement</h6>
            <canvas id="paymentPie"></canvas>
        </div>
    </div>

    <!-- Histogramme des Revenus -->
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm p-3 h-100">
            <h6>Histogramme des Revenus</h6>
            <canvas id="revenueHistogram"></canvas>
        </div>
    </div>

    <!-- RÃ©partition des Sources de Revenus -->
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm p-3 h-100">
            <h6>Sources de Revenus</h6>
            <canvas id="sourcesPie"></canvas>
        </div>
    </div>

    <!-- Moyenne Mensuelle des Revenus -->
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm p-3 h-100">
            <h6>Moyenne Mensuelle des Revenus</h6>
            <canvas id="monthlyAverageLine"></canvas>
        </div>
    </div>
</div>

    

    <!-- DerniÃ¨res DÃ©clarations -->
    <div class="card mt-4 p-3">
        <h4>DerniÃ¨res DÃ©clarations</h4>
        <ul>
            {% for decl in declarations|slice(-5) %}
                <li>
                    ðŸ“… {{ decl.dateDeclaration }} | ðŸ’° {{ decl.montantRevenu }} TND | 
                    Source: {{ decl.sourceRevenu }}
                </li>
            {% else %}
                <li>Aucune dÃ©claration disponible.</li>
            {% endfor %}
        </ul>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const dossiers = {{ dossiers|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }};
    const declarations = {{ declarations|json_encode(constant('JSON_UNESCAPED_UNICODE'))|raw }};

    // Bar Chart - ImpÃ´ts
    const paid = dossiers.filter(d => d.status === 'PayÃ©').length;
    const unpaid = dossiers.length - paid;

    new Chart(document.getElementById('impotBar'), {
        type: 'bar',
        data: {
            labels: ['PayÃ©', 'Non PayÃ©'],
            datasets: [{
                label: 'Nombre de Dossiers',
                data: [paid, unpaid],
                backgroundColor: ['#4CAF50', '#F44336']
            }]
        }
    });

    // Pie Chart - Moyens de Paiement
    const paymentMethods = {};
    dossiers.forEach(d => {
        const method = d.moyenPayement || 'Inconnu';
        paymentMethods[method] = (paymentMethods[method] || 0) + 1;
    });

    new Chart(document.getElementById('paymentPie'), {
        type: 'pie',
        data: {
            labels: Object.keys(paymentMethods),
            datasets: [{
                label: 'Moyens de Paiement',
                data: Object.values(paymentMethods),
                backgroundColor: ['#2196F3', '#FF9800', '#9C27B0', '#00BCD4']
            }]
        }
    });

    // Line Chart - Total ImpÃ´t vs PayÃ©
    const labelsTime = dossiers.map(d => d.dateCreation);
    const totalImpotData = dossiers.map(d => d.totalImpot);
    const totalImpotPayeData = dossiers.map(d => d.totalImpotPaye);

    new Chart(document.getElementById('lineImpot'), {
        type: 'line',
        data: {
            labels: labelsTime,
            datasets: [
                {
                    label: 'Total ImpÃ´t',
                    data: totalImpotData,
                    borderColor: '#4CAF50',
                    fill: false
                },
                {
                    label: 'Total PayÃ©',
                    data: totalImpotPayeData,
                    borderColor: '#F44336',
                    fill: false
                }
            ]
        }
    });

    // Line Chart - DÃ©clarations de Revenus dans le Temps
    const declLabels = declarations.map(d => d.dateDeclaration);
    const declRevenus = declarations.map(d => d.montantRevenu);

    new Chart(document.getElementById('declarationsLine'), {
        type: 'line',
        data: {
            labels: declLabels,
            datasets: [{
                label: 'Revenus DÃ©clarÃ©s',
                data: declRevenus,
                borderColor: '#673AB7',
                backgroundColor: 'rgba(103, 58, 183, 0.2)',
                fill: true
            }]
        }
    });
    // Histogramme des Revenus
new Chart(document.getElementById('revenueHistogram'), {
    type: 'bar',
    data: {
        labels: declarations.map(d => d.dateDeclaration),
        datasets: [{
            label: 'Montant',
            data: declarations.map(d => d.montantRevenu),
            backgroundColor: '#00bcd4'
        }]
    },
    options: {
        scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 5 } },
            y: { beginAtZero: true }
        }
    }
});

// Pie - Sources de Revenus
const sources = {};
declarations.forEach(d => {
    const source = d.sourceRevenu || 'Autre';
    sources[source] = (sources[source] || 0) + 1;
});

new Chart(document.getElementById('sourcesPie'), {
    type: 'pie',
    data: {
        labels: Object.keys(sources),
        datasets: [{
            data: Object.values(sources),
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4CAF50']
        }]
    }
});

// Moyenne Mensuelle des Revenus
const monthlyGroups = {};
declarations.forEach(d => {
    const [year, month] = d.dateDeclaration.split('-');
    const key = `${year}-${month}`;
    monthlyGroups[key] = monthlyGroups[key] || [];
    monthlyGroups[key].push(d.montantRevenu);
});

const monthlyLabels = Object.keys(monthlyGroups).sort();
const monthlyAverages = monthlyLabels.map(key => {
    const sum = monthlyGroups[key].reduce((a, b) => a + b, 0);
    return (sum / monthlyGroups[key].length).toFixed(2);
});

new Chart(document.getElementById('monthlyAverageLine'), {
    type: 'line',
    data: {
        labels: monthlyLabels,
        datasets: [{
            label: 'Moyenne Mensuelle',
            data: monthlyAverages,
            borderColor: '#9C27B0',
            backgroundColor: 'rgba(156, 39, 176, 0.2)',
            fill: true
        }]
    }
});


</script>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
fetch('/api/statistics/users')
  .then(response => response.json())
  .then(data => {
    document.getElementById('totalUsers').textContent = data.active + data.inactive;
    document.getElementById('totalActifs').textContent = data.active;
    document.getElementById('totalInactifs').textContent = data.inactive;
    document.getElementById('totalMois').textContent = data.monthly[data.monthly.length - 1]?.count || 0;

    new ApexCharts(document.querySelector("#chart-role"), {
      chart: { type: 'donut', animations: { enabled: true } },
      series: Object.values(data.roles),
      labels: Object.keys(data.roles),
      title: { text: 'RÃ©partition par rÃ´le' },
      dataLabels: { enabled: true },
      legend: { position: 'bottom' },
      colors: ['#6f42c1', '#198754']
    }).render();

    new ApexCharts(document.querySelector("#chart-status"), {
      chart: { type: 'pie' },
      series: [data.active, data.inactive],
      labels: ['Actifs', 'Inactifs'],
      title: { text: 'Statut des comptes' },
      legend: { position: 'bottom' },
      colors: ['#28a745', '#dc3545']
    }).render();

    new ApexCharts(document.querySelector("#chart-monthly"), {
      chart: {
        type: 'bar',
        toolbar: { show: false },
        animations: { enabled: true, easing: 'easeinout', speed: 500 }
      },
      series: [{ name: 'Inscriptions', data: data.monthly.map(m => m.count) }],
      xaxis: { categories: data.monthly.map(m => m.month) },
      title: { text: 'Inscriptions mensuelles' },
      colors: ['#775DD0']
    }).render();
  });
</script>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
{% endblock %}
