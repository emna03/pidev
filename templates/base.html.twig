{% extends 'base.html.twig' %}

{% block title %}Détails du Quartier{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f5f5f5; }
        .weather-icon { font-size: 1.5rem; vertical-align: middle; }
        .temperature { margin-left: 5px; }
        .feature-box { display: flex; align-items: center; margin-bottom: 5px; }
        .feature-box .feature-box-icon {
            width: 2.7em; height: 2.7em; background-color: var(--primary);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin-right: 10px; color: white;
        }
        .feature-box-info { flex: 1; }
        .weather-popup { text-align: center; margin-top: 10px; }
    </style>
{% endblock %}

{% block body %}
    <h2 class="text-center mb-5">Détails du Quartier</h2>

    <div class="card mb-4">
        <div class="card-body">
            <h4 class="card-title">Quartier n°{{ quartier.id }}</h4>
            <table class="table table-bordered mt-3">
                <tbody>
                    <tr><th>Nom</th><td>{{ quartier.nom }}</td></tr>
                    <tr><th>Consommation Totale</th><td>
                        {% set totalConsommation = 0 %}
                        {% for lampadaire in lampadaires %}
                            {% set totalConsommation = totalConsommation + lampadaire.consommation %}
                        {% endfor %}
                        {{ totalConsommation }} kWh
                    </td></tr>
                </tbody>
            </table>
            <a href="/quartier" class="btn btn-secondary mt-3"><i class="fas fa-arrow-left"></i> Retour à la liste</a>
            <a href="{{ path('app_quartier_show_pdf', {'id': quartier.id}) }}" class="btn btn-danger mt-3 ms-2" target="_blank">
                <i class="fas fa-file-pdf"></i> Exporter en PDF
            </a>
        </div>
    </div>

    <div class="card mb-5">
        <div class="card-body">
            <h4 class="card-title">Liste des Lampadaires (cliquez pour localiser)</h4>
            <table class="table table-hover mt-3">
                <thead>
                    <tr>
                        <th>Localisation</th>
                        <th>Consommation</th>
                        <th>État</th>
                        <th>Date d'installation</th>
                        <th>Météo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for lampadaire in lampadaires %}
                    <tr class="clickable-row"
                        data-localisation="{{ lampadaire.localisation }}"
                        data-consommation="{{ lampadaire.consommation }}"
                        data-etat="{{ lampadaire.etat }}">
                        <td>{{ lampadaire.localisation }}</td>
                        <td>{{ lampadaire.consommation }} kWh</td>
                        <td><span class="badge bg-{{ lampadaire.etat == 0 ? 'success' : 'danger' }}">{{ lampadaire.etat == 0 ? 'Actif' : 'Inactif' }}</span></td>
                        <td>{{ lampadaire.dateInstallation|date('d/m/Y') }}</td>
                        <td class="weather-data-{{ loop.index }}">
                            <div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <h3 class="text-center mb-4">Carte des Lampadaires</h3>
    <div id="map" style="height: 400px; border-radius: 8px;"></div>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    {{ include('quartier/_quartier_map_script.html.twig') }}
{% endblock %}
